---
- name: Clonar repositório e executar script.sh com verificação do Git
  hosts: all
  become: yes

  tasks:
    - name: Verificar se o Git está instalado
      command: git --version
      register: git_check
      ignore_errors: yes

    - name: Instalar o Git se não estiver presente
      apt:
        name: git
        state: present
        update_cache: yes
      when: git_check.rc != 0

    - name: Clonar o repositório do GitHub
      git:
        repo: https://github.com/Redeley/zabbix-update.git
        dest: /tmp/zabbix-update
        version: HEAD

    - name: Garantir permissão de execução para script.sh
      file:
        path: /tmp/zabbix-update/install_zabbix_7.sh
        mode: '0755'

    - name: Executar o script
      command: /tmp/zabbix-update/install_zabbix_7.sh

    - name: Executar script no servidor remoto e capturar saída
      shell: bash {{ script_remoto }}
      register: script_output
      ignore_errors: yes  # opcional, se você quiser que erros no script não parem o playbook

    - name: Exibir saída do script na interface AWX
      debug:
        var: script_output.stdout_lines
